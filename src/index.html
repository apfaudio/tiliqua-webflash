<!DOCTYPE html>
<html>
<head>
    <title>Tiliqua Flash Tool</title>
    <meta charset="UTF-8">
    <script src="coi-serviceworker.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #000;
            color: #4af;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #4af;
            font-size: 18px;
            font-weight: normal;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .controls {
            margin-bottom: 15px;
        }
        button, select {
            font-family: 'JetBrains Mono', monospace;
            background: #000;
            color: #4af;
            border: 1px solid #4af;
            padding: 6px 12px;
            margin-right: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        button:hover:not(:disabled), select:hover:not(:disabled) {
            background: #4af;
            color: #000;
        }
        button:disabled, select:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        label[for="archive"] {
            font-family: 'JetBrains Mono', monospace;
            background: #000;
            color: #4af;
            border: 1px solid #4af;
            padding: 6px 12px;
            margin-right: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-block;
        }
        label[for="archive"]:hover {
            background: #4af;
            color: #000;
        }
        label[for="archive"].disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        #status {
            color: #4af;
            font-size: 13px;
        }
        #terminal {
            margin-top: 20px;
            border: 1px solid #4af;
            padding: 10px;
        }
        #terminal .xterm-viewport::-webkit-scrollbar {
            width: 10px;
        }
        #terminal .xterm-viewport::-webkit-scrollbar-track {
            background: #000;
        }
        #terminal .xterm-viewport::-webkit-scrollbar-thumb {
            background: #4af;
            border: 1px solid #000;
        }
        #terminal .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: #6cf;
        }
    </style>
</head>
<body>
    <h1>Tiliqua Flash Tool</h1>

    <div class="controls">
        <button id="connect">Connect to Tiliqua</button>
        <span id="status">Not connected</span>
    </div>

    <div class="controls">
        <label for="archive" class="disabled" id="archive-label">Choose File</label>
        <input type="file" id="archive" accept=".tar.gz" disabled>
        <select id="slot" disabled>
            <option value="null">Bootloader</option>
            <option value="0" selected>Slot 0</option>
            <option value="1">Slot 1</option>
            <option value="2">Slot 2</option>
            <option value="3">Slot 3</option>
            <option value="4">Slot 4</option>
            <option value="5">Slot 5</option>
            <option value="6">Slot 6</option>
            <option value="7">Slot 7</option>
        </select>
        <button id="flash" disabled>Flash</button>
    </div>

    <div id="terminal"></div>

    <script type="module">
import { runOpenFPGALoader, Exit } from 'https://cdn.jsdelivr.net/npm/@yowasp/openfpgaloader/gen/bundle.js';

// Global state
let pyodide = null;
let tiliquaHwVersion = null;
let selectedFile = null;
let term = null;

function initTerminal() {
    term = new Terminal({
        theme: {
            background: '#000',
            foreground: '#fff'
        },
        fontFamily: '"JetBrains Mono", monospace',
        fontSize: 14,
        convertEol: true
    });
    term.open(document.getElementById('terminal'));
    term.writeln('Terminal initialized. Waiting for Pyodide...');
}

function log(message, style = '') {
    if (term) {
        term.writeln(style + message + '\x1b[0m');
    }
}

// Initialize Pyodide
async function initPyodide() {
    log('Loading Pyodide...');
    pyodide = await loadPyodide();

    await pyodide.loadPackage('micropip');
    const micropip = pyodide.pyimport('micropip');
    await micropip.install(['dataclasses-json', 'colorama']);

    const emptyInitFiles = [
        'tiliqua/__init__.py',
        'tiliqua/build/__init__.py',
        'tiliqua/flash/__init__.py',
        'rs/__init__.py',
        'rs/manifest/__init__.py',
        'rs/manifest/src/__init__.py',
    ];

    for (const file of emptyInitFiles) {
        const dir = file.substring(0, file.lastIndexOf('/'));
        if (dir) {
            const parts = dir.split('/');
            let currentPath = '';
            for (const part of parts) {
                currentPath = currentPath ? `${currentPath}/${part}` : part;
                try {
                    pyodide.FS.mkdir(currentPath);
                } catch (e) {}
            }
        }
        pyodide.FS.writeFile(file, '');
    }

    const pythonFiles = [
        'tiliqua/build/types.py',
        'tiliqua/flash/archive_loader.py',
        'tiliqua/flash/spiflash_layout.py',
        'tiliqua/flash/openfpgaloader.py',
        'rs/manifest/src/lib.py',
        'rs/manifest/src/lib.rs',
    ];

    for (const file of pythonFiles) {
        const response = await fetch(file);
        if (!response.ok) {
            throw new Error(`Failed to load ${file}: HTTP ${response.status}`);
        }
        const content = await response.text();
        const dir = file.substring(0, file.lastIndexOf('/'));
        if (dir) {
            const parts = dir.split('/');
            let currentPath = '';
            for (const part of parts) {
                currentPath = currentPath ? `${currentPath}/${part}` : part;
                try {
                    pyodide.FS.mkdir(currentPath);
                } catch (e) {}
            }
        }
        pyodide.FS.writeFile(file, content);
    }

    log('\x1b[32mReady\x1b[0m');
    document.getElementById('connect').disabled = false;
}

async function scanForTiliqua() {
    try {
        const devices = await navigator.usb.getDevices();
        let tiliquaDevice = null;

        for (const device of devices) {
            if (device.productName &&
                (device.productName.toLowerCase().includes('apfbug') ||
                 device.productName.toLowerCase().includes('apf.audio'))) {
                tiliquaDevice = device;
                break;
            }
        }

        if (!tiliquaDevice) {
            tiliquaDevice = await navigator.usb.requestDevice({ filters: [] });
        }

        const productName = tiliquaDevice.productName || "";
        if (!productName.toLowerCase().includes('apfbug') &&
            !productName.toLowerCase().includes('apf.audio')) {
            throw new Error("Selected device is not a Tiliqua debugger");
        }

        const hwVersionMatch = productName.match(/R(\d+)/);
        if (!hwVersionMatch) {
            throw new Error("Product code is malformed (update RP2040?)");
        }

        tiliquaHwVersion = parseInt(hwVersionMatch[1]);
        log(`\x1b[32mConnected: ${productName} (R${tiliquaHwVersion}, ${tiliquaDevice.serialNumber})\x1b[0m`);

        const statusEl = document.getElementById('status');
        statusEl.textContent = `Connected: ${productName}`;
        statusEl.style.color = '#4CAF50';

        document.getElementById('archive').disabled = false;
        document.getElementById('archive-label').classList.remove('disabled');
        return tiliquaHwVersion;

    } catch (error) {
        let errorMsg = error.message || "Unknown error";
        let additionalInfo = "Check device is on, plugged in ('dbg' port), permissions correct, RP2040 firmware up to date.";

        if ((error.message && error.message.includes("navigator.usb is undefined")) ||
            (!navigator.usb)) {
            errorMsg = "WebUSB is not supported in this browser";
            additionalInfo = "Use Chrome, Edge, or another Chromium-based browser.";
        }

        log(`\x1b[31m${errorMsg}\x1b[0m`);
        log(`\x1b[31m${additionalInfo}\x1b[0m`)

        const statusEl = document.getElementById('status');
        statusEl.textContent = `Error: ${errorMsg}`;
        statusEl.style.color = '#ff6b6b';
        return null;
    }
}

async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        selectedFile = await file.arrayBuffer();
        log(`Loaded: ${file.name} (${selectedFile.byteLength} bytes)`);
        document.getElementById('archive-label').textContent = file.name;
        document.getElementById('slot').disabled = false;
        document.getElementById('flash').disabled = false;
    }
}

async function handleFlash() {
    if (!selectedFile || tiliquaHwVersion === null) {
        log('\x1b[31mNo file or device\x1b[0m');
        return;
    }

    const slotValue = document.getElementById('slot').value;
    const slot = slotValue === 'null' ? null : parseInt(slotValue);

    log('');
    log(`\x1b[1mFlashing to ${slot === null ? 'Bootloader' : 'Slot ' + slot}\x1b[0m`);

    try {
        document.getElementById('flash').disabled = true;
        document.getElementById('slot').disabled = true;
        document.getElementById('archive').disabled = true;

        pyodide.globals.set('archive_bytes', new Uint8Array(selectedFile));
        pyodide.globals.set('slot_value', slot);
        pyodide.globals.set('hw_rev_value', tiliquaHwVersion);

        const result = await pyodide.runPythonAsync(`
import io
import tarfile
import json
from tiliqua.build.types import BitstreamManifest, RegionType
from tiliqua.flash.spiflash_layout import compute_concrete_regions_to_flash

# Extract archive
archive_buffer = io.BytesIO(bytes(archive_bytes))
files = {}

with tarfile.open(fileobj=archive_buffer, mode='r:gz') as tar:
    for member in tar.getmembers():
        if member.isfile():
            f = tar.extractfile(member)
            files[member.name] = f.read()

# Parse manifest
manifest_json = files.get('manifest.json')
if not manifest_json:
    raise ValueError("No manifest.json found in archive")

manifest_dict = json.loads(manifest_json.decode('utf-8'))
manifest = BitstreamManifest.from_dict(manifest_dict)

# Validate hardware
if manifest.hw_rev != hw_rev_value:
    raise ValueError(f"Hardware mismatch: attached Tiliqua (hw=r{hw_rev_value}) does not match archive (hw=r{manifest.hw_rev})")

# Check if bootloader or user bitstream
is_bootloader = any(r.region_type == RegionType.XipFirmware for r in manifest.regions)
if is_bootloader and slot_value is not None:
    raise ValueError("Bootloader bitstream must be flashed to bootloader slot (select 'Bootloader' option)")
elif not is_bootloader and slot_value is None:
    raise ValueError("User bitstream requires a slot selection (0-7)")

# Compute concrete regions
concrete_manifest, regions_to_flash = compute_concrete_regions_to_flash(manifest, slot_value)

# Update manifest in files
files['manifest.json'] = json.dumps(concrete_manifest.to_dict()).encode('utf-8')

# Generate operations
operations = []
for i, region in enumerate(sorted(regions_to_flash)):
    if region.memory_region.region_type == RegionType.OptionStorage:
        continue  # Skip option storage

    filename = region.memory_region.filename
    if filename not in files:
        raise ValueError(f"File {filename} referenced in manifest but not found in archive")

    data = files[filename]

    operations.append({
        'filename': filename,
        'data': list(data),  # Convert bytes to list for JSON
        'offset': region.addr,
        'file_type': 'raw',
        'skip_reset': i < len(regions_to_flash) - 1
    })

result = {
    'operations': operations,
    'manifest': concrete_manifest.to_dict(),
    'is_bootloader': is_bootloader
}

json.dumps(result)
        `);

        const processedData = JSON.parse(result);

        log(`${processedData.manifest.name}`);
        log('');
        for (const op of processedData.operations) {
            const data = new Uint8Array(op.data);

            const args = [
                '-c', 'dirtyJtag',
                '-f',
                '-o', `0x${op.offset.toString(16)}`,
                '--file-type', op.file_type
            ];

            if (op.skip_reset) {
                args.push('--skip-reset');
            }

            args.push('data');

            log(`\x1b[34m$ openFPGALoader ${args.join(' ')}\x1b[0m`);

            const filesIn = { 'data': data };

            try {
                await runOpenFPGALoader(args, filesIn, {
                    stdout: (data) => {
                        if (data && term) {
                            term.write(new TextDecoder().decode(data));
                        }
                    },
                    stderr: (data) => {
                        if (data && term) {
                            term.write(new TextDecoder().decode(data));
                        }
                    }
                });
            } catch (error) {
                if (error instanceof Exit) {
                    throw new Error(`Command failed with exit code ${error.code}`);
                }
                throw error;
            }
        }

        log('');
        log('\x1b[32mDone\x1b[0m');

    } catch (error) {
        log('');
        log(`\x1b[31m${error.message}\x1b[0m`);
    } finally {
        document.getElementById('flash').disabled = false;
        document.getElementById('slot').disabled = false;
        document.getElementById('archive').disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initTerminal();
    initPyodide();
    document.getElementById('connect').addEventListener('click', scanForTiliqua);
    document.getElementById('archive').addEventListener('change', handleFileSelect);
    document.getElementById('flash').addEventListener('click', handleFlash);
});
    </script>
</body>
</html>
